---
title: "Database Improvement Workflow"
author: "Robin Rohwer"
date: "Last Updated 3/28/2018"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
```

These are steps that you can add to TaxAss in order to check for mistakes in your 
custom database.  Some of them are scripts that you run as part of TaxAss, and others 
are scripts that you use before TaxAss directly on the files that arb exports.

*the file names are not consistent yet*

# I. Pre-workflow scripts 

Follow these sections of `how_to_format_FreshTrain_ARB_export_for_TaxAss.html` to get the starting FreshTrain file:  

* ARB export  
* Simple Reformatting 
* Remove Non-FreshTrain References  

Don't do the later steps of adjusting coarse-level nomenclature, this workflow here helps you figure 
out *how* to adjust the coarse-level nomenclature.

--------------------------------------------------------------------------------------------

# II. In-workflow scripts 

These scripts are part of the workflow, so they are in the tax-scripts
folder and they require files generated in the workflow. Call these 
scripts with these different flags from within your workflow working 
directory and at the correct point in the workflow processing.)


1. compare custom and general database names (R)

2. Find typos that result in an two lower-taxa-level orgs of the same name having a different upper name
	find_typos.R

3. Find high-read seqIDs that are missing in the FW database- prioritize adding these sequences
	Find_Abund_SeqIDs_to_Add.R


___________________________________________________________________________________________



===========================================================================================
I. Mid-workflow scripts:
===========================================================================================
___________________________________________________________________________________________

1. Compare general database classification of your custom database representative OTUs to
	identify drift in database curation as they are updated separately.

10.5 compare custom and general databases (mothur, bash)
	mothur "#classify.seqs(fasta=custom.fasta, template=general.fasta, taxonomy=general.taxonomy, method=wang, probs=T, processors=2)"
	cat custom.general.wang.taxonomy > custom.general.taxonomy
	sed 's/[[:blank:]]/\;/' <custom.general.taxonomy >custom.general.taxonomy.reformatted
	mv custom.general.taxonomy.reformatted custom.general.taxonomy
	sed 's/[[:blank:]]/\;/' <custom.taxonomy >custom.custom.taxonomy
	mkdir conflicts_database
	Rscript find_classification_disagreements.R custom.custom.taxonomy custom.general.taxonomy NA conflicts_database NA NA 70 database 
	note, can also add database conflicts to the plot from within RStudio, but took the input out of the plot_classification_disagreements.R terminal call.


*****description*****


___________________________________________________________________________________________

1. workflow step 10.5, 11.5, 12.5, and manual step 13.5



***description***




___________________________________________________________________________________________

2. This uses the R script find_typos.R, which is not ready for terminal call yet.




***description***



___________________________________________________________________________________________

3. Find high-read seqIDs that are missing in the FW database- prioritize adding these sequences

not sourceable from command line yet

***description***






# <span style="color:SteelBlue">11.5 (don't do this step)</span>

#####  <span style="color:SteelBlue">11.5 assign taxonomy to custom database with general database (mothur, bash)</span>

This is used in the `Database_Improvement_Workflow.txt` in the `arb-scripts` folder. 
It's basically pointless to do if you're not working on the quality of the custom database,
but if you want to you can read more about that in a note at the end of step 14.

By classifying the custom database with the general database you can:  

- Compare your two databases to get an idea of the baseline level of disagreement you 
	  can expect from their taxonomy classifications.  This was not super helpful so you can't
	  do it from the command line anymore, you have to open up step 14's 
	  plot_classification_disagreements.R and uncomment out that part to do it manually.
- Generate a list of database disagreements that you can use to update your custom
	  database classifications to better match your general database using the .csv files
	  generated in step 12. 

Full Two Commands (Type in Terminal):
```
mothur "#classify.seqs(fasta=custom.fasta, template=general.fasta, taxonomy=general.taxonomy, method=wang, probs=T, processors=2, cutoff=0)"
cat custom.general.wang.taxonomy custom.general.taxonomy
```

(See step 9 for a detailed explanation of these two commands and their arguments.)  

file names                      | description
--------------------------------|----------------------------------------------
`custom.fasta`					        | the fasta file of the small, custom database
`general.fasta`					        | the fasta file of the large, general database
`custom.general.wang.taxonomy`  | the taxonomy of your custom database assigned by the general database<br>this is the default name created by mothur
`custom.general.taxonomy`			  | the custom.general.wang.taxonomy file renamed
	








